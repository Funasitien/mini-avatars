<!DOCTYPE html>
<html lang="fr-FR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="{{ url_for('static', filename='editor.css') }}"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <title>OR Editor</title>
  </head>
  <body>
    <div class="boxy">
      <div style="position: absolute; top: 0.6rem; left: 0.6rem;">
        <a class="btn mc-gray mobileit" href="../" style="padding-bottom: 6px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 24 24">
            <path fill="currentColor" d="M14 2h-4v2H8v2H6v2H4v2H2v2h2v10h7v-6h2v6h7V12h2v-2h-2V8h-2V6h-2V4h-2zm0 2v2h2v2h2v2h2v2h-2v8h-3v-6H9v6H6v-8H4v-2h2V8h2V6h2V4z"/>
          </svg>
          Home
        </a>
      </div>
      <div style="position: absolute; top: 0.6rem; right: 0.6rem;">
        <button class="btn mc-green mobileit" id="downloadBtn" style="padding-bottom: 6px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 24 24">
            <path fill="currentColor" d="M11 4h2v8h2v2h-2v2h-2v-2H9v-2h2zm-2 8H7v-2h2zm6 0v-2h2v2zM4 18h16v2H4z"/>
          </svg>
          Dowload
        </button>
      </div>

      <div style="height: 61.5vh;">
        <!-- Preview canvas -->
        <div style="text-align: center; padding-top: 4vh; display: block;">
          <img id="preview" />
        </div>
      </div>

        <!-- Tabs navs -->
      <div>
        <ul class="nav nav-tabs pb-2" id="ex1" role="tablist" style="justify-content: center; gap: 6px;">
          <li class="nav-item" role="presentation">
            <a
              data-mdb-tab-init
              class="nav-link active"
              id="ex1-tab-4"
              href="#ex1-tabs-4"
              role="tab"
              aria-controls="ex1-tabs-4"
              aria-selected="true"
              >Background</a
            >
          </li>
          <li class="nav-item" role="presentation">
            <a
              data-mdb-tab-init
              class="nav-link"
              id="ex1-tab-1"
              href="#ex1-tabs-1"
              role="tab"
              aria-controls="ex1-tabs-1"
              aria-selected="true"
              >Skins</a
            >
          </li>
          <li class="nav-item" role="presentation">
            <a
              data-mdb-tab-init
              class="nav-link"
              id="ex1-tab-5"
              href="#ex1-tabs-5"
              role="tab"
              aria-controls="ex1-tabs-5"
              aria-selected="true"
              >Eyes</a
            >
          </li>
          <li class="nav-item" role="presentation">
            <a
              data-mdb-tab-init
              class="nav-link"
              id="ex1-tab-6"
              href="#ex1-tabs-6"
              role="tab"
              aria-controls="ex1-tabs-6"
              aria-selected="true"
              >Eyes +</a
            >
          </li>
          
          <li class="nav-item" role="presentation">
            <a
              data-mdb-tab-init
              class="nav-link"
              id="ex1-tab-3"
              href="#ex1-tabs-3"
              role="tab"
              aria-controls="ex1-tabs-3"
              aria-selected="false"
              >Hairs</a
            >
          </li>
          <li class="nav-item" role="presentation">
            <a
              data-mdb-tab-init
              class="nav-link"
              id="ex1-tab-8"
              href="#ex1-tabs-8"
              role="tab"
              aria-controls="ex1-tabs-8"
              aria-selected="false"
              >Mouth</a
            >
          </li>
          <li class="nav-item" role="presentation">
            <a
              data-mdb-tab-init
              class="nav-link"
              id="ex1-tab-2"
              href="#ex1-tabs-2"
              role="tab"
              aria-controls="ex1-tabs-2"
              aria-selected="false"
              >Cloth</a
            >
          </li>
          <li class="nav-item" role="presentation">
            <a
              data-mdb-tab-init
              class="nav-link"
              id="ex1-tab-7"
              href="#ex1-tabs-7"
              role="tab"
              aria-controls="ex1-tabs-7"
              aria-selected="false"
              >PLUS</a
            >
          </li>
          
        </ul>
        <!-- Tabs navs -->

      <!-- Tabs content -->
      <div class="tab-content editor pt-3" id="ex1-content" style="padding-bottom: 1.4rem!important;">
        <div
          class="tab-pane fade show active"
          id="ex1-tabs-4"
          role="tabpanel"
          aria-labelledby="ex1-tab-4"
        >
          {% for image in bg_images %}
          <button
            class="component-button"
            data-component="bg"
            data-value="{{ image }}"
            style="background-image: url({{ url_for('static', filename='bg/'+image) }});"
          >
          </button>
          {% endfor %}
        </div>
        <div
          class="tab-pane fade"
          id="ex1-tabs-1"
          role="tabpanel"
          aria-labelledby="ex1-tab-1"
        >
          {% for image in skin_images %}
          <button
            class="component-button"
            data-component="skin"
            data-value="{{ image }}"
            style="background-image: url({{ url_for('static', filename='skin/'+image) }});"
          >
          </button>
          {% endfor %}
        </div>
        <div
          class="tab-pane fade"
          id="ex1-tabs-2"
          role="tabpanel"
          aria-labelledby="ex1-tab-2"
        >
          {% for image in cloth_images %}
          <button
            class="component-button"
            data-component="cloth"
            data-value="{{ image }}"
            style="background-image: url({{ url_for('static', filename='cloth/'+image) }});"
          >
          </button>
          {% endfor %}
        </div>
        <div
          class="tab-pane fade"
          id="ex1-tabs-3"
          role="tabpanel"
          aria-labelledby="ex1-tab-3"
        >
          {% for image in hair_images %}
          <button
            class="component-button"
            data-component="hair"
            data-value="{{ image }}"
            style="background-image: url({{ url_for('static', filename='hair/'+image) }});"
          >
          </button>
          {% endfor %}
        </div>
        <div
          class="tab-pane fade"
          id="ex1-tabs-5"
          role="tabpanel"
          aria-labelledby="ex1-tab-5"
        >
          {% for image in eyes_images %}
          <button
            class="component-button"
            data-component="eyes"
            data-value="{{ image }}"
            style="background-image: url({{ url_for('static', filename='eyes/'+image) }});"
          >
          </button>
          {% endfor %}
        </div>
        <div
          class="tab-pane fade"
          id="ex1-tabs-6"
          role="tabpanel"
          aria-labelledby="ex1-tab-6"
        >
          {% for image in eyes_plus %}
          <button
            class="component-button"
            data-component="eyesplus"
            data-value="{{ image }}"
            style="background-image: url({{ url_for('static', filename='eyesplus/'+image) }});"
          >
          </button>
          {% endfor %}
        </div>
        <div
          class="tab-pane fade"
          id="ex1-tabs-8"
          role="tabpanel"
          aria-labelledby="ex1-tab-8"
        >
          {% for image in mouth_images %}
          <button
            class="component-button"
            data-component="mouth"
            data-value="{{ image }}"
            style="background-image: url({{ url_for('static', filename='mouth/'+image) }});"
          >
          </button>
          {% endfor %}
        </div>
        <div
          class="tab-pane fade"
          id="ex1-tabs-7"
          role="tabpanel"
          aria-labelledby="ex1-tab-7"
        >
          {% for image in plus %}
          <button
            class="component-button"
            data-component="plus"
            data-value="{{ image }}"
            style="background-image: url({{ url_for('static', filename='plus/'+image) }});"
          >
          </button>
          {% endfor %}
        </div>
      </div>
    </div>
    </div>
    <!-- MDB -->
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.umd.min.js"
    ></script>
    <script>
      // Render on load
      const componentButtons = document.querySelectorAll(".component-button");

      let selected = {
        bg: "default.png",
        skin: "body_steve.png",
        cloth: "default.png",
        hair: "hair_brown_steve.png",
        eyes: "eyes_blue_steve.png",
        eyesplus: "eyebrows_brown_steve.png",
        mouth: "mouth_steve.png",
        plus: "empty.png",
      };

      componentButtons.forEach((button) => {
        button.addEventListener("click", (e) => {
          let component = button.dataset.component;
          let value = button.dataset.value;

          selected[component] = value;
          console.log(selected)

          renderPreview();
        });
      });

      function renderPreview() {
        fetch(`/render_preview?bg=${selected.bg}&skin=${selected.skin}&cloth=${selected.cloth}&hair=${selected.hair}&eyes=${selected.eyes}&eyesplus=${selected.eyesplus}&mouth=${selected.mouth}&plus=${selected.plus}`)
        .then(response => response.blob())
        .then(imageBlob => {
          document.getElementById('preview').src = URL.createObjectURL(imageBlob);
        });
      }

      // Render on change
      async function slow_renderPreview() {
        // Load images
        let bg = selected.bg;
        let skin = selected.skin;
        let cloth = selected.cloth;
        let hair = selected.hair;
        let eyes = selected.eyes;
        let eyesplus = selected.eyesplus;
        let mouth = selected.mouth;
        let plus = selected.plus;

        let bgImg = await fetch(`/static/bg/${bg}`);
        let skinImg = await fetch(`/static/skin/${skin}`);
        let clothImg = await fetch(`/static/cloth/${cloth}`);
        let hairImg = await fetch(`/static/hair/${hair}`);
        let eyesImg = await fetch(`/static/eyes/${eyes}`);
        let eyesplusImg = await fetch(`/static/eyesplus/${eyesplus}`);
        let mouthImg = await fetch(`/static/mouth/${mouth}`);
        let plusImg = await fetch(`/static/plus/${plus}`);
        
        let imBg = await createImageBitmap(await bgImg.blob());
        let imSkin = await createImageBitmap(await skinImg.blob());
        let imCloth = await createImageBitmap(await clothImg.blob());
        let imHair = await createImageBitmap(await hairImg.blob());
        let imEyes = await createImageBitmap(await eyesImg.blob());
        let imEyesPlus = await createImageBitmap(await eyesplusImg.blob());
        let imMouth = await createImageBitmap(await mouthImg.blob());
        let imPlus = await createImageBitmap(await plusImg.blob());
        
        // Composite
        let canvas = document.createElement("canvas");

        canvas.width = 630; 
        canvas.height = 630;

        canvas.getContext("2d").drawImage(imBg, 0, 0);
        canvas.getContext("2d").drawImage(imSkin, 0, 0);
        canvas.getContext("2d").drawImage(imMouth, 0, 0);
        canvas.getContext("2d").drawImage(imPlus, 0, 0);
        canvas.getContext("2d").drawImage(imEyes, 0, 0);
        canvas.getContext("2d").drawImage(imEyesPlus, 0, 0);
        canvas.getContext("2d").drawImage(imCloth, 0, 0);
        canvas.getContext("2d").drawImage(imHair, 0, 0);

        // Update preview
        document.getElementById("preview").src = canvas.toDataURL();
      }


      // Get component selections
      function downloadAvatar() {
        let query = `/render_preview?bg=${selected.bg}&skin=${selected.skin}&cloth=${selected.cloth}&hair=${selected.hair}&eyes=${selected.eyes}&eyesplus=${selected.eyesplus}&mouth=${selected.mouth}&plus=${selected.mouth}`;

        // Trigger download
        fetch(query)
          .then((response) => response.blob())
          .then((blob) => {
            let url = URL.createObjectURL(blob);
            let a = document.createElement("a");
            a.href = url;
            a.download = "or-avatar.png";
            a.click();
          });
      }

      // Add click handler
      document
        .getElementById("downloadBtn")
        .addEventListener("click", downloadAvatar);

      renderPreview();
    </script>
  </body>
</html>
